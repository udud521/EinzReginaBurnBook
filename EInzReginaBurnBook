local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local PhysicsService = game:GetService("PhysicsService")

local player = Players.LocalPlayer

-- UI 생성 (G2L)
local bookGui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
bookGui.IgnoreGuiInset = true
bookGui.ScreenInsets = Enum.ScreenInsets.DeviceSafeInsets
bookGui.Name = "BookGui"
bookGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
bookGui.ResetOnSpawn = false

local closedBook = Instance.new("ImageButton", bookGui)
closedBook.BorderSizePixel = 0
closedBook.BackgroundTransparency = 1
closedBook.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
closedBook.Image = "rbxassetid://92949541355058"
closedBook.Size = UDim2.new(0, 200, 0, 275)
closedBook.BorderColor3 = Color3.fromRGB(0, 0, 0)
closedBook.Name = "ClosedBook"
closedBook.Position = UDim2.new(0.83425, 0, 0.27387, 0)

local openBookFrame = Instance.new("Frame", bookGui)
openBookFrame.Active = true
openBookFrame.BorderSizePixel = 0
openBookFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
openBookFrame.Size = UDim2.new(0, 340, 0, 260)
openBookFrame.Position = UDim2.new(0.73174, 0, 0.28395, 0)
openBookFrame.BorderColor3 = Color3.fromRGB(0, 0, 0)
openBookFrame.Name = "OpenBookFrame"
openBookFrame.BackgroundTransparency = 1
openBookFrame.Visible = false

local gossipCommand = Instance.new("TextBox", openBookFrame)
gossipCommand.CursorPosition = -1
gossipCommand.Name = "GossipCommand"
gossipCommand.TextXAlignment = Enum.TextXAlignment.Left
gossipCommand.PlaceholderColor3 = Color3.fromRGB(199, 42, 53)
gossipCommand.BorderSizePixel = 0
gossipCommand.TextWrapped = true
gossipCommand.TextStrokeColor3 = Color3.fromRGB(199, 42, 53)
gossipCommand.TextSize = 14
gossipCommand.TextColor3 = Color3.fromRGB(199, 42, 53)
gossipCommand.TextScaled = true
gossipCommand.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
gossipCommand.FontFace = Font.new("rbxasset://fonts/families/Kalam.json", Enum.FontWeight.Regular, Enum.FontStyle.Normal)
gossipCommand.ClearTextOnFocus = false
gossipCommand.Size = UDim2.new(0, 282, 0, 30)
gossipCommand.Position = UDim2.new(0.085, 0, 0.204, 0)
gossipCommand.BorderColor3 = Color3.fromRGB(0, 0, 0)
gossipCommand.Text = ""
gossipCommand.BackgroundTransparency = 1

local tearButton = Instance.new("ImageButton", openBookFrame)
tearButton.BorderSizePixel = 0
tearButton.BackgroundTransparency = 1
tearButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
tearButton.ZIndex = 2
tearButton.Image = "rbxassetid://127584164564988"
tearButton.Size = UDim2.new(0, 120, 0, 100)
tearButton.BorderColor3 = Color3.fromRGB(0, 0, 0)
tearButton.Name = "TearButton"
tearButton.Rotation = 101
tearButton.Position = UDim2.new(0.77647, 0, 0.52692, 0)
tearButton.Visible = false

local openBookImage = Instance.new("ImageLabel", openBookFrame)
openBookImage.BorderSizePixel = 0
openBookImage.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
openBookImage.Image = "rbxassetid://116810517427218"
openBookImage.Size = UDim2.new(1, 0, 1, 0)
openBookImage.BorderColor3 = Color3.fromRGB(0, 0, 0)
openBookImage.BackgroundTransparency = 1
openBookImage.Name = "OpenBookImage"
openBookImage.Visible = false

-- 드래그 변수
local dragging = false
local dragStartPos, frameStartPos

openBookFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        local ok, target = pcall(function() return input.Target end)
        if ok and target == gossipCommand then return end

        dragging = true
        dragStartPos = input.Position
        frameStartPos = openBookFrame.Position

        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStartPos
        openBookFrame.Position = UDim2.new(
            frameStartPos.X.Scale, frameStartPos.X.Offset + delta.X,
            frameStartPos.Y.Scale, frameStartPos.Y.Offset + delta.Y
        )
    end
end)

-- 애니메이션, 노클립 관련 변수
local animationLoopConnection = nil
local animationStopFlag = false
local noclipGroupName = "NoCollideAll"

-- 캐릭터 원본 + 복제용 변수
local originalHumanoid = nil
local godHumanoid = nil

-- 충돌 그룹 최초 생성
pcall(function()
    local groups = PhysicsService:GetCollisionGroups()
    local found = false
    for _, g in pairs(groups) do
        if g.name == noclipGroupName then
            found = true
            break
        end
    end
    if not found then
        PhysicsService:CreateCollisionGroup(noclipGroupName)
        PhysicsService:CollisionGroupSetCollidable(noclipGroupName, "Default", false)
        PhysicsService:CollisionGroupSetCollidable(noclipGroupName, noclipGroupName, false)
    end
end)

-- 캐릭터 노클립 적용 함수
local function ApplyNoClip(character)
    for _, part in pairs(character:GetDescendants()) do
        if part:IsA("BasePart") then
            PhysicsService:SetPartCollisionGroup(part, noclipGroupName)
        end
    end
end

-- 캐릭터 노클립 해제 함수
local function RemoveNoClip(character)
    for _, part in pairs(character:GetDescendants()) do
        if part:IsA("BasePart") then
            PhysicsService:SetPartCollisionGroup(part, "Default")
        end
    end
end

-- god 상태 복제 + 설정 함수 (원래 god 명령어 기능 가져옴)
local function ApplyGodState()
    local char = player.Character
    if not char then return end
    local humanoid = char:FindFirstChildWhichIsA("Humanoid")
    if not humanoid then return end

    originalHumanoid = humanoid

    -- 복제하고 캐릭터 세팅
    local newHumanoid = humanoid:Clone()
    newHumanoid.Parent = char

    -- 상태 비활성화
    newHumanoid:SetStateEnabled(Enum.HumanoidStateType.Dead, false)
    newHumanoid:SetStateEnabled(Enum.HumanoidStateType.Physics, false)
    newHumanoid:SetStateEnabled(Enum.HumanoidStateType.PlatformStanding, false)
    newHumanoid.BreakJointsOnDeath = true

    humanoid:Destroy()
    player.Character = char

    -- 카메라 세팅
    local cam = workspace.CurrentCamera
    cam.CameraSubject = newHumanoid
    cam.CFrame = cam.CFrame

    newHumanoid.DisplayDistanceType = Enum.HumanoidDisplayDistanceType.None

    -- 애니메이션 초기화
    local animateScript = char:FindFirstChild("Animate")
    if animateScript then
        animateScript.Disabled = true
        task.wait()
        animateScript.Disabled = false
    end

    newHumanoid.Health = newHumanoid.MaxHealth

    godHumanoid = newHumanoid
end

-- 애니메이션 정지
local function StopAllAnimations(humanoid)
    for _, track in pairs(humanoid:GetPlayingAnimationTracks()) do
        track:Stop()
        track:Destroy()
    end
end

-- 애니메이션 재생용 애니 리스트
local suckAnimations = {
    {id = "4210116953", speed = 3},
    {id = "4555808220", speed = 2},
    {id = "7422527690", speed = 2},
}

-- suck 명령어 애니메이션 + 위치 유지
local function PlaySuckSequence(targetPlayer)
    if not targetPlayer.Character then return end
    local targetRoot = targetPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not targetRoot then return end

    local char = player.Character
    if not char then return end
    local root = char:FindFirstChild("HumanoidRootPart")
    local humanoid = char:FindFirstChildWhichIsA("Humanoid")
    if not root or not humanoid then return end

    animationStopFlag = false

    -- god 상태 적용
    ApplyGodState()
    ApplyNoClip(char)

    StopAllAnimations(humanoid)

    if animationLoopConnection then
        animationLoopConnection:Disconnect()
    end

    -- 위치 지속 업데이트 (타겟 앞 아래)
    animationLoopConnection = RunService.Stepped:Connect(function()
        if animationStopFlag then return end
        if root and targetRoot then
            local forward = targetRoot.CFrame.LookVector.Unit
            local offset = forward * 1.2 + Vector3.new(0, -0.7, 0)  -- 조금 더 아래로
            root.CFrame = CFrame.new(targetRoot.Position + offset, targetRoot.Position)
        end
    end)

    -- 애니메이션 반복 재생
    task.spawn(function()
        while not animationStopFlag do
            for _, emote in ipairs(suckAnimations) do
                if animationStopFlag then break end
                local anim = Instance.new("Animation")
                anim.AnimationId = "rbxassetid://" .. emote.id
                local track = humanoid:LoadAnimation(anim)
                track.Looped = false
                track:Play()
                track:AdjustSpeed(emote.speed or 1)
                local done = false
                track.Stopped:Connect(function() done = true end)
                repeat task.wait(0.1) until done or animationStopFlag
                track:Destroy()
            end
        end
    end)
end

-- fuck 명령어 애니메이션 + 위치 유지
local function PlayFuckSequence(targetPlayer)
    if not targetPlayer.Character then return end
    local targetRoot = targetPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not targetRoot then return end

    local char = player.Character
    if not char then return end
    local root = char:FindFirstChild("HumanoidRootPart")
    local humanoid = char:FindFirstChildWhichIsA("Humanoid")
    if not root or not humanoid then return end

    animationStopFlag = false

    -- god 상태 적용
    ApplyGodState()
    ApplyNoClip(char)

    StopAllAnimations(humanoid)

    if animationLoopConnection then
        animationLoopConnection:Disconnect()
    end

    -- 위치 지속 업데이트 (타겟 바로 앞 아래 위치)
    animationLoopConnection = RunService.Stepped:Connect(function()
        if animationStopFlag then return end
        if root and targetRoot then
            local forward = targetRoot.CFrame.LookVector.Unit
            local offset = forward * 1.2 + Vector3.new(0, -0.7, 0)
            root.CFrame = CFrame.new(targetRoot.Position + offset, targetRoot.Position)
        end
    end)

    -- 단일 애니메이션 무한 반복 재생
    local anim = Instance.new("Animation")
    anim.AnimationId = "rbxassetid://7942885103"  -- 기존 fuck 애니메이션 아이디
    local track = humanoid:LoadAnimation(anim)
    track.Looped = false
    track:Play()
    track:AdjustSpeed(2)

    task.spawn(function()
        while not animationStopFlag do
            if track.TimePosition >= 1.85 then
                track.TimePosition = 0
            end
            task.wait(0.03)
        end
    end)
end

-- 69 명령어 (god 상태 + 노클립 + 위치 유지)
local function Play69Sequence(targetPlayer)
    if not targetPlayer.Character then return end
    local targetRoot = targetPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not targetRoot then return end

    local char = player.Character
    if not char then return end
    local root = char:FindFirstChild("HumanoidRootPart")
    local humanoid = char:FindFirstChildWhichIsA("Humanoid")
    if not root or not humanoid then return end

    animationStopFlag = false

    -- god 상태 적용
    ApplyGodState()
    ApplyNoClip(char)

    StopAllAnimations(humanoid)

    if animationLoopConnection then
        animationLoopConnection:Disconnect()
    end

    -- 위치 지속 업데이트 (타겟 앞 아래 위치)
    animationLoopConnection = RunService.Stepped:Connect(function()
        if animationStopFlag then return end
        if root and targetRoot then
            local forward = targetRoot.CFrame.LookVector.Unit
            local offset = forward * 1.2 + Vector3.new(0, -0.7, 0)
            root.CFrame = CFrame.new(targetRoot.Position + offset, targetRoot.Position)
        end
    end)
end

-- 플레이어 이름 찾기 (대소문자 무시)
local function FindPlayerByNameOrDisplayName(name)
    name = name:lower()
    for _, plr in pairs(Players:GetPlayers()) do
        if plr.Name:lower() == name or plr.DisplayName:lower() == name then
            return plr
        end
    end
    return nil
end

-- 커맨드 처리 함수
local function HandleCommand(text)
    local args = string.split(text, " ")
    if #args < 2 then return end

    local command = args[1]:lower()
    local targetName = args[2]
    local targetPlayer = FindPlayerByNameOrDisplayName(targetName)
    if not targetPlayer then return end

    -- 프로필 이미지 업데이트 (필요시)
    -- UpdateProfileImage(targetPlayer.UserId) -- 생략 가능

    if command == "suck" then
        PlaySuckSequence(targetPlayer)
    elseif command == "fuck" then
        PlayFuckSequence(targetPlayer)
    elseif command == "69" then
        Play69Sequence(targetPlayer)
    else
        return
    end

    tearButton.Visible = true
end

-- TearButton 클릭 시 애니메이션 종료, 노클립 해제, UI 정리
tearButton.MouseButton1Click:Connect(function()
    animationStopFlag = true

    if animationLoopConnection then
        animationLoopConnection:Disconnect()
        animationLoopConnection = nil
    end

    local char = player.Character
    if char then
        -- 노클립 해제
        RemoveNoClip(char)

        local humanoid = char:FindFirstChildWhichIsA("Humanoid")
        if humanoid then
            StopAllAnimations(humanoid)
        end
    end

    tearButton.Visible = false
    openBookFrame.Visible = false
    closedBook.Visible = true
    openBookImage.Visible = false
end)

-- GossipCommand 입력 엔터 처리
gossipCommand.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        local text = gossipCommand.Text
        if text and text ~= "" then
            HandleCommand(text)
        end
    end
end)

-- ClosedBook 클릭 시 열기
closedBook.MouseButton1Click:Connect(function()
    openBookFrame.Position = UDim2.new(0.732, 0, 0.284, 0)
    openBookFrame.Visible = true
    closedBook.Visible = false
    openBookImage.Visible = true
end)

-- 캐릭터 리스폰 시 노클립 다시 적용 (god 상태가 유지 중일 때)
player.CharacterAdded:Connect(function(char)
    task.wait(1)
    if not animationStopFlag then
        ApplyNoClip(char)
        ApplyGodState()
    end
end)
