local G2L = {}

-- ScreenGui 생성
G2L["1"] = Instance.new("ScreenGui", game:GetService("Players").LocalPlayer:WaitForChild("PlayerGui"))
G2L["1"].Name = "BookGui"
G2L["1"].IgnoreGuiInset = true
G2L["1"].ResetOnSpawn = false
G2L["1"].ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- ClosedBook 버튼
G2L["2"] = Instance.new("ImageButton", G2L["1"])
G2L["2"].Name = "ClosedBook"
G2L["2"].BackgroundTransparency = 1
G2L["2"].BorderSizePixel = 0
G2L["2"].Size = UDim2.new(0, 200, 0, 275)
G2L["2"].Position = UDim2.new(0.83, 0, 0.27, 0)
G2L["2"].Image = "rbxassetid://92949541355058"

-- OpenBookFrame 프레임
G2L["3"] = Instance.new("Frame", G2L["1"])
G2L["3"].Name = "OpenBookFrame"
G2L["3"].Size = UDim2.new(0, 340, 0, 260)
G2L["3"].Position = UDim2.new(0.73, 0, 0.28, 0)
G2L["3"].BackgroundTransparency = 1
G2L["3"].Visible = false

-- GossipCommand 텍스트박스
G2L["9"] = Instance.new("TextBox", G2L["3"])
G2L["9"].Name = "GossipCommand"
G2L["9"].Size = UDim2.new(0, 282, 0, 30)
G2L["9"].Position = UDim2.new(0.08, 0, 0.20, 0)
G2L["9"].ClearTextOnFocus = false
G2L["9"].Text = ""
G2L["9"].BackgroundTransparency = 1
G2L["9"].TextColor3 = Color3.fromRGB(199, 42, 53)
G2L["9"].PlaceholderColor3 = Color3.fromRGB(199, 42, 53)
G2L["9"].TextXAlignment = Enum.TextXAlignment.Left
G2L["9"].TextScaled = true
G2L["9"].Font = Enum.Font.Kalam

-- TearButton (닫기)
G2L["7"] = Instance.new("ImageButton", G2L["3"])
G2L["7"].Name = "TearButton"
G2L["7"].Size = UDim2.new(0, 120, 0, 100)
G2L["7"].Position = UDim2.new(0.77, 0, 0.52, 0)
G2L["7"].BackgroundTransparency = 1
G2L["7"].BorderSizePixel = 0
G2L["7"].Image = "rbxassetid://127584164564988"
G2L["7"].Visible = false

-- LocalScript 본문
G2L["a"] = Instance.new("LocalScript", G2L["1"])

local function C_a()
	local script = G2L["a"]
	local Players = game:GetService("Players")
	local RunService = game:GetService("RunService")
	local player = Players.LocalPlayer
	local playerGui = player:WaitForChild("PlayerGui")
	local bookGui = playerGui:WaitForChild("BookGui")

	local ClosedBook = bookGui:WaitForChild("ClosedBook")
	local OpenBookFrame = bookGui:WaitForChild("OpenBookFrame")
	local GossipCommand = OpenBookFrame:WaitForChild("GossipCommand")
	local TearButton = OpenBookFrame:WaitForChild("TearButton")

	OpenBookFrame.Visible = false
	TearButton.Visible = false

	local animationLoopConnection = nil
	local animationStopFlag = false

	local function StopAllAnimations(humanoid)
		for _, track in pairs(humanoid:GetPlayingAnimationTracks()) do
			track:Stop()
			track:Destroy()
		end
	end

	local function FindPlayerByNameOrDisplayName(name)
		name = name:lower()
		for _, plr in pairs(Players:GetPlayers()) do
			if plr.Name:lower() == name or plr.DisplayName:lower() == name then
				return plr
			end
		end
		return nil
	end

	local function PlayFuckSequence(targetPlayer)
		local char = player.Character or player.CharacterAdded:Wait()
		local humanoid = char:WaitForChild("Humanoid")
		local root = char:WaitForChild("HumanoidRootPart")
		local targetChar = targetPlayer.Character
		local targetRoot = targetChar and targetChar:FindFirstChild("HumanoidRootPart")
		if not targetRoot then return end

		StopAllAnimations(humanoid)
		animationStopFlag = false

		if animationLoopConnection then
			animationLoopConnection:Disconnect()
		end

		-- 바라보는 방향만 대상과 같게 맞춤
		local lookVector = targetRoot.CFrame.LookVector
		local currentPos = root.CFrame.Position
		root.CFrame = CFrame.new(currentPos, currentPos + lookVector)

		local anim = Instance.new("Animation")
		anim.AnimationId = "rbxassetid://7942885103"
		local track = humanoid:LoadAnimation(anim)
		track.Looped = false
		track:Play()
		track:AdjustSpeed(2)

		animationLoopConnection = RunService.Stepped:Connect(function()
			if animationStopFlag then
				if animationLoopConnection then
					animationLoopConnection:Disconnect()
					animationLoopConnection = nil
				end
				return
			end
			if root and targetRoot then
				-- 대상 앞쪽(앞 방향)으로 1.2, 아래로 0.5 오프셋 위치로 이동
				local forward = targetRoot.CFrame.LookVector.Unit
				local offsetPos = targetRoot.Position + forward * 1.2 + Vector3.new(0, -0.5, 0)
				root.CFrame = CFrame.new(offsetPos, targetRoot.Position)
			end
		end)
	end

	TearButton.MouseButton1Click:Connect(function()
		TearButton.Visible = false
		animationStopFlag = true
		if animationLoopConnection then
			animationLoopConnection:Disconnect()
			animationLoopConnection = nil
		end
		local char = player.Character
		if char then
			local humanoid = char:FindFirstChild("Humanoid")
			if humanoid then
				StopAllAnimations(humanoid)
			end
		end
	end)

	local function HandleCommand(text)
		local args = string.split(text, " ")
		if #args < 2 then return end

		local command = args[1]:lower()
		local targetName = args[2]
		local targetPlayer = FindPlayerByNameOrDisplayName(targetName)
		if not targetPlayer then return end

		if command == "fuck" then
			PlayFuckSequence(targetPlayer)
			TearButton.Visible = true
		end
	end

	GossipCommand.FocusLost:Connect(function(enterPressed)
		if enterPressed then
			local text = GossipCommand.Text
			if text and text ~= "" then
				HandleCommand(text)
			end
		end
	end)

	ClosedBook.MouseButton1Click:Connect(function()
		OpenBookFrame.Position = UDim2.new(0.732, 0, 0.284, 0)
		OpenBookFrame.Visible = true
		ClosedBook.Visible = false
	end)
end

task.spawn(C_a)

return G2L["1"]
