-- BookGui Script with suck, fuck, and 69 commands

local G2L = {}

-- (UI 구성 부분 생략 - 현재 상태 그대로 유지됨)
-- 이 아래는 LocalScript 구현

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local bookGui = playerGui:WaitForChild("BookGui")

local ClosedBook = bookGui:WaitForChild("ClosedBook")
local OpenBookFrame = bookGui:WaitForChild("OpenBookFrame")
local OpenBookImage = OpenBookFrame:WaitForChild("OpenBookImage")
local GossipCommand = OpenBookFrame:WaitForChild("GossipCommand")
local TearButton = OpenBookFrame:WaitForChild("TearButton")
local ProfileDisplay = OpenBookFrame:WaitForChild("ProfileDisplay")
local ProfileImage = ProfileDisplay:WaitForChild("ProfileImage")

OpenBookFrame.Visible = false
TearButton.Visible = false
OpenBookImage.Visible = false

local dragging = false
local dragStartPos, frameStartPos

OpenBookFrame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 and input.Target ~= GossipCommand then
		dragging = true
		dragStartPos = input.Position
		frameStartPos = OpenBookFrame.Position
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then dragging = false end
		end)
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
		local delta = input.Position - dragStartPos
		OpenBookFrame.Position = UDim2.new(
			frameStartPos.X.Scale, frameStartPos.X.Offset + delta.X,
			frameStartPos.Y.Scale, frameStartPos.Y.Offset + delta.Y
		)
	end
end)

local function UpdateProfileImage(userId)
	local success, thumb = pcall(function()
		return Players:GetUserThumbnailAsync(userId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size100x100)
	end)
	if success then
		ProfileImage.Image = thumb
	end
end

local function StopAllAnimations(humanoid)
	for _, track in pairs(humanoid:GetPlayingAnimationTracks()) do
		track:Stop()
		track:Destroy()
	end
end

local animationStopFlag = false
local animationLoopConnection = nil

local function AttachToFrontOf(targetRoot, heightOffset, rotateY, rotateX)
	local myRoot = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
	if not myRoot then return end
	animationStopFlag = false
	if animationLoopConnection then animationLoopConnection:Disconnect() end
	animationLoopConnection = RunService.Stepped:Connect(function()
		if animationStopFlag or not targetRoot or not myRoot then return end
		local look = targetRoot.CFrame.LookVector
		local pos = targetRoot.Position + look * 1.2 + Vector3.new(0, heightOffset or -0.5, 0)
		local cf = CFrame.new(pos, targetRoot.Position)
		if rotateY then cf = cf * CFrame.Angles(0, math.rad(180), 0) end
		if rotateX then cf = cf * CFrame.Angles(math.rad(180), 0, 0) end
		myRoot.CFrame = cf
	end)
end

local function PlayAnimation(animId, speed)
	local humanoid = player.Character and player.Character:FindFirstChild("Humanoid")
	if not humanoid then return end
	StopAllAnimations(humanoid)
	local anim = Instance.new("Animation")
	anim.AnimationId = "rbxassetid://" .. animId
	local track = humanoid:LoadAnimation(anim)
	track:Play(0.1)
	track:AdjustSpeed(speed or 1)
end

local function HandleCommand(text)
	local args = string.split(text, " ")
	if #args < 2 then return end
	local cmd = args[1]:lower()
	local targetName = args[2]
	local targetPlayer
	for _, p in ipairs(Players:GetPlayers()) do
		if p.Name:lower() == targetName:lower() or p.DisplayName:lower() == targetName:lower() then
			targetPlayer = p
			break
		end
	end
	if not targetPlayer then return end
	UpdateProfileImage(targetPlayer.UserId)
	local targetChar = targetPlayer.Character
	local targetRoot = targetChar and targetChar:FindFirstChild("HumanoidRootPart")
	if not targetRoot then return end
	
	if cmd == "suck" then
		PlayAnimation("4210116953", 3)
		AttachToFrontOf(targetRoot)
	elseif cmd == "fuck" then
		PlayAnimation("14884037124", 2)
		AttachToFrontOf(targetRoot, -0.5, true, false)
	elseif cmd == "69" then
		PlayAnimation("5918726674", 3)
		AttachToFrontOf(targetRoot, 0, false, true)
	end
	TearButton.Visible = true
end

GossipCommand.FocusLost:Connect(function(enter)
	if enter then
		HandleCommand(GossipCommand.Text)
	end
end)

TearButton.MouseButton1Click:Connect(function()
	animationStopFlag = true
	if animationLoopConnection then animationLoopConnection:Disconnect() end
	ProfileImage.Image = ""
	TearButton.Visible = false
	local humanoid = player.Character and player.Character:FindFirstChild("Humanoid")
	if humanoid then StopAllAnimations(humanoid) end
end)

ClosedBook.MouseButton1Click:Connect(function()
	OpenBookFrame.Visible = true
	ClosedBook.Visible = false
	OpenBookImage.Visible = true
	OpenBookImage.Image = "rbxassetid://116810517427218"
	OpenBookImage.Position = UDim2.new(0, 0, 0, 0)
	OpenBookImage.Size = UDim2.new(1, 0, 1, 0)
	OpenBookImage.BackgroundTransparency = 1
end)

return G2L["1"]
